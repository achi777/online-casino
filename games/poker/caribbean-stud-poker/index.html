<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caribbean Stud Poker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a3d62 0%, #1e5f74 50%, #3c6e71 100%);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; color: #fff;
        }
        .game-container {
            background: linear-gradient(135deg, rgba(26, 77, 46, 0.95), rgba(13, 59, 46, 0.95));
            border-radius: 20px; padding: 40px;
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.8);
            text-align: center; max-width: 1000px; width: 95%;
            border: 5px solid #8B4513;
        }
        h1 {
            font-size: 3em; margin-bottom: 15px;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
            font-weight: bold; letter-spacing: 3px;
        }
        .subtitle { font-size: 1.2em; color: #FFD700; margin-bottom: 20px; font-style: italic; }
        .balance-display {
            font-size: 1.6em; margin-bottom: 30px; padding: 18px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            border-radius: 12px; border: 2px solid #FFD700;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        .balance-amount { color: #FFD700; font-weight: bold; font-size: 1.4em; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .paytable {
            background: rgba(0, 0, 0, 0.5); padding: 15px;
            border-radius: 10px; margin-bottom: 25px; border: 2px solid #FFD700;
        }
        .paytable-title { font-size: 1.2em; color: #FFD700; margin-bottom: 10px; font-weight: bold; }
        .paytable-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 5px; font-size: 0.9em; }
        .paytable-item { padding: 5px; }
        .paytable-hand { text-align: left; color: #FFA500; }
        .paytable-payout { text-align: right; color: #FFD700; font-weight: bold; }
        .table {
            background: linear-gradient(135deg, rgba(0, 100, 0, 0.8), rgba(0, 80, 0, 0.8));
            border-radius: 15px; padding: 30px; margin: 25px 0;
            border: 3px solid #8B4513; box-shadow: inset 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        .dealer-section, .player-section { margin: 20px 0; }
        .section-title { font-size: 1.3em; color: #FFD700; margin-bottom: 15px; font-weight: bold; }
        .hand { display: flex; justify-content: center; gap: 10px; min-height: 140px; align-items: center; flex-wrap: wrap; }
        .card {
            width: 85px; height: 120px; background: white; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 8px; font-size: 1.5em; font-weight: bold;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6); transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-5px); }
        .card.back { background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%); color: #FFD700; font-size: 3em; justify-content: center; }
        .card.red { color: #DC143C; }
        .card.black { color: #000; }
        .card-top { display: flex; flex-direction: column; align-items: center; }
        .card-suit { font-size: 2em; }
        .hand-name { margin-top: 10px; font-size: 1.2em; color: #FFD700; font-weight: bold; min-height: 30px; }
        .controls { margin-top: 30px; }
        .bet-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .bet-button {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 215, 0, 0.2));
            border: 2px solid #FFD700; color: #FFD700; padding: 14px 28px; border-radius: 10px;
            cursor: pointer; font-size: 1.3em; font-weight: bold; transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        .bet-button:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.6), rgba(255, 215, 0, 0.4));
            transform: scale(1.08); box-shadow: 0 7px 20px rgba(255, 215, 0, 0.5);
        }
        .bet-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .bet-amount { font-size: 1.6em; color: #FFD700; min-width: 170px; font-weight: bold; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .action-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .action-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none; color: #000; padding: 18px 50px; font-size: 1.5em;
            border-radius: 10px; cursor: pointer; font-weight: bold;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
            transition: all 0.3s; text-transform: uppercase;
        }
        .action-button.raise { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); color: white; }
        .action-button.fold { background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%); color: white; }
        .action-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(255, 215, 0, 0.8); }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .message { margin-top: 25px; font-size: 2em; min-height: 60px; font-weight: bold; text-shadow: 0 0 15px currentColor; }
        .win { color: #00FF00; text-shadow: 0 0 20px #00FF00; animation: pulse 0.6s infinite; }
        .lose { color: #FF6B6B; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } }
        .error { color: #ff6b6b; background: rgba(255, 107, 107, 0.2); padding: 12px; border-radius: 10px; margin-top: 15px; border: 2px solid #ff6b6b; }
        .loading { color: #FFD700; font-size: 1.4em; }
        .game-info { font-size: 0.9em; color: #FFD700; margin-top: 15px; font-style: italic; }
        @keyframes dealCard { 0% { transform: translateY(-100px) rotateY(180deg); opacity: 0; } 100% { transform: translateY(0) rotateY(0); opacity: 1; } }
        .card.dealing { animation: dealCard 0.5s ease-out; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ðŸŒ´ CARIBBEAN STUD POKER ðŸŒ´</h1>
        <div class="subtitle">5-Card Poker â€¢ Ante â€¢ Raise</div>
        <div id="status" class="loading">Loading...</div>
        <div id="game-content" style="display: none;">
            <div class="balance-display">Balance: <span class="balance-amount" id="balance">100.00</span> â‚¾</div>
            <div class="paytable">
                <div class="paytable-title">PAYTABLE</div>
                <div class="paytable-grid">
                    <div class="paytable-item paytable-hand">Royal Flush</div><div class="paytable-item paytable-payout">100:1</div>
                    <div class="paytable-item paytable-hand">Straight Flush</div><div class="paytable-item paytable-payout">50:1</div>
                    <div class="paytable-item paytable-hand">Four of a Kind</div><div class="paytable-item paytable-payout">20:1</div>
                    <div class="paytable-item paytable-hand">Full House</div><div class="paytable-item paytable-payout">7:1</div>
                    <div class="paytable-item paytable-hand">Flush</div><div class="paytable-item paytable-payout">5:1</div>
                    <div class="paytable-item paytable-hand">Straight</div><div class="paytable-item paytable-payout">4:1</div>
                    <div class="paytable-item paytable-hand">Three of a Kind</div><div class="paytable-item paytable-payout">3:1</div>
                    <div class="paytable-item paytable-hand">Two Pair</div><div class="paytable-item paytable-payout">2:1</div>
                    <div class="paytable-item paytable-hand">Pair or Less</div><div class="paytable-item paytable-payout">1:1</div>
                </div>
            </div>
            <div class="table">
                <div class="dealer-section">
                    <div class="section-title">ðŸŽ© Dealer</div>
                    <div class="hand" id="dealer-hand"></div>
                    <div class="hand-name" id="dealer-hand-name"></div>
                </div>
                <div class="player-section">
                    <div class="section-title">ðŸ‘¤ You</div>
                    <div class="hand" id="player-hand"></div>
                    <div class="hand-name" id="player-hand-name"></div>
                </div>
            </div>
            <div class="controls">
                <div class="bet-controls">
                    <button class="bet-button" id="decrease-bet" onclick="decreaseBet()">âˆ’</button>
                    <div class="bet-amount">Ante: <span id="bet-amount">5.00</span> â‚¾</div>
                    <button class="bet-button" id="increase-bet" onclick="increaseBet()">+</button>
                </div>
                <div class="action-buttons">
                    <button class="action-button" id="deal-btn" onclick="dealHand()">Deal</button>
                    <button class="action-button raise" id="raise-btn" onclick="raiseHand()" disabled>Raise (2x)</button>
                    <button class="action-button fold" id="fold-btn" onclick="foldHand()" disabled>Fold</button>
                </div>
            </div>
            <div class="message" id="message"></div>
            <div class="game-info">Dealer qualifies with Ace-King or better</div>
        </div>
    </div>
    <script>
        const BACKEND_URL = 'http://localhost:8080';
        const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const valueOrder = { '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14 };
        let balance = 0, betAmount = 5, sessionToken = '', isDemo = false, gameId = null, gameInProgress = false;
        let playerHand = [], dealerHand = [], deck = [];
        const urlParams = new URLSearchParams(window.location.search);
        sessionToken = urlParams.get('session') || '';
        isDemo = urlParams.get('demo') === 'true';

        async function init() {
            const statusEl = document.getElementById('status');
            console.log('=== CARIBBEAN STUD INIT ===');
            if (isDemo) { balance = 100; updateBalance(); showGame(); return; }
            if (!sessionToken) { statusEl.innerHTML = '<div class="error">No session token found</div>'; return; }
            // Real money mode
            {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/user/balance?sessionToken=${sessionToken}`);
                    if (response.ok) {
                        const data = await response.json();
                        balance = data.balance; updateBalance();
                        const gameInfoResponse = await fetch(`${BACKEND_URL}/api/user/game-info?sessionToken=${sessionToken}`);
                        if (gameInfoResponse.ok) { const gameData = await gameInfoResponse.json(); gameId = gameData.gameId; }
                        showGame();
                    }
                } catch (error) { isDemo = true; balance = 100; setTimeout(() => { updateBalance(); showGame(); }, 2000); }
            }
        }
        function showGame() { document.getElementById('status').style.display = 'none'; document.getElementById('game-content').style.display = 'block'; }
        function updateBalance() { document.getElementById('balance').textContent = balance.toFixed(2); }
        function increaseBet() { if (!gameInProgress && betAmount < balance && betAmount < 100) { betAmount += 5; if (betAmount > balance) betAmount = balance; document.getElementById('bet-amount').textContent = betAmount.toFixed(2); } }
        function decreaseBet() { if (!gameInProgress && betAmount > 5) { betAmount -= 5; document.getElementById('bet-amount').textContent = betAmount.toFixed(2); } }
        function createDeck() { deck = []; for (let suit of suits) { for (let value of values) { deck.push({ value, suit }); } } for (let i = deck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [deck[i], deck[j]] = [deck[j], deck[i]]; } }
        function drawCard() { return deck.pop(); }
        function displayCard(card, isHidden = false) {
            const cardEl = document.createElement('div'); cardEl.className = 'card dealing';
            if (isHidden) { cardEl.classList.add('back'); cardEl.innerHTML = 'ðŸ‚ '; }
            else { const isRed = card.suit === 'â™¥' || card.suit === 'â™¦'; cardEl.classList.add(isRed ? 'red' : 'black'); cardEl.innerHTML = `<div class="card-top"><div>${card.value}</div><div class="card-suit">${card.suit}</div></div><div>${card.value}</div>`; }
            return cardEl;
        }
        function displayHands(hideDealerCards = true) {
            const dealerHandEl = document.getElementById('dealer-hand'); dealerHandEl.innerHTML = '';
            dealerHand.forEach(card => { dealerHandEl.appendChild(displayCard(card, hideDealerCards)); });
            const playerHandEl = document.getElementById('player-hand'); playerHandEl.innerHTML = '';
            playerHand.forEach(card => { playerHandEl.appendChild(displayCard(card)); });
            if (!hideDealerCards) { const dealerHandRank = evaluateHand(dealerHand); document.getElementById('dealer-hand-name').textContent = dealerHandRank.name; }
            const playerHandRank = evaluateHand(playerHand); document.getElementById('player-hand-name').textContent = playerHandRank.name;
        }
        async function dealHand() {
            if (balance < betAmount) { showMessage('Insufficient balance!', 'lose'); return; }
            gameInProgress = true; document.getElementById('message').textContent = ''; document.getElementById('dealer-hand-name').textContent = ''; document.getElementById('player-hand-name').textContent = '';
            document.getElementById('decrease-bet').disabled = true; document.getElementById('increase-bet').disabled = true; document.getElementById('deal-btn').disabled = true;
            if (isDemo) { balance -= betAmount; updateBalance(); }
            createDeck(); playerHand = [drawCard(), drawCard(), drawCard(), drawCard(), drawCard()]; dealerHand = [drawCard(), drawCard(), drawCard(), drawCard(), drawCard()];
            displayHands(true); document.getElementById('raise-btn').disabled = false; document.getElementById('fold-btn').disabled = false;
        }
        async function raiseHand() {
            document.getElementById('raise-btn').disabled = true; document.getElementById('fold-btn').disabled = true;
            if (isDemo) { balance -= betAmount * 2; updateBalance(); }
            displayHands(false); await new Promise(resolve => setTimeout(resolve, 1000));
            if (!isDemo) {
                const roundId = 'round_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                try {
                    const response = await fetch(`${BACKEND_URL}/api/user/games/spin`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionToken: sessionToken, gameId: gameId, betAmount: betAmount * 3, roundId: roundId })
                    });
                    if (response.ok) { const result = await response.json(); balance = result.newBalance; updateBalance(); showMessage(result.win ? result.message : (result.message || 'Dealer wins'), result.win ? 'win' : 'lose'); }
                } catch (error) { showMessage('Error during raise', 'lose'); }
            } else { determineWinner(); }
            resetGame();
        }
        async function foldHand() {
            document.getElementById('raise-btn').disabled = true; document.getElementById('fold-btn').disabled = true;
            showMessage('You folded. Ante lost.', 'lose'); resetGame();
        }
        function determineWinner() {
            const playerHandRank = evaluateHand(playerHand); const dealerHandRank = evaluateHand(dealerHand);
            const dealerQualifies = dealerHandRank.rank >= 1 || (dealerHandRank.rank === 0 && dealerHandRank.hasAceKing);
            let totalWin = 0, message = '';
            if (!dealerQualifies) { totalWin = betAmount * 3; message = `Dealer doesn't qualify! You win ${betAmount.toFixed(2)} â‚¾`; balance += totalWin; showMessage(message, 'win'); }
            else if (playerHandRank.rank > dealerHandRank.rank || (playerHandRank.rank === dealerHandRank.rank && playerHandRank.highCard > dealerHandRank.highCard)) {
                const bonusPayouts = [0, 1, 2, 3, 4, 5, 7, 20, 50, 100]; totalWin = betAmount * 3 + (betAmount * 2 * bonusPayouts[playerHandRank.rank]);
                message = `${playerHandRank.name}! You win ${(totalWin - betAmount * 3).toFixed(2)} â‚¾!`; balance += totalWin; showMessage(message, 'win');
            } else if (playerHandRank.rank === dealerHandRank.rank && playerHandRank.highCard === dealerHandRank.highCard) {
                totalWin = betAmount * 3; balance += totalWin; showMessage('Push - Bets returned', 'lose');
            } else { showMessage('Dealer wins', 'lose'); }
            updateBalance();
        }
        function evaluateHand(cards) {
            const sorted = [...cards].sort((a, b) => valueOrder[a.value] - valueOrder[b.value]);
            const valueCounts = {}, suitCounts = {};
            sorted.forEach(card => { valueCounts[card.value] = (valueCounts[card.value] || 0) + 1; suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1; });
            const counts = Object.values(valueCounts).sort((a, b) => b - a); const isFlush = Object.values(suitCounts).some(count => count === 5);
            const values = sorted.map(c => valueOrder[c.value]); let isStraight = true;
            for (let i = 1; i < values.length; i++) { if (values[i] !== values[i-1] + 1) { isStraight = false; break; } }
            if (!isStraight && values[0] === 2 && values[4] === 14) { const lowAce = [2, 3, 4, 5, 14]; isStraight = values.every((v, i) => v === lowAce[i]); }
            const royalValues = ['10', 'J', 'Q', 'K', 'A']; const isRoyal = isFlush && isStraight && sorted.every(c => royalValues.includes(c.value));
            const highCard = Math.max(...values); const hasAceKing = values[4] === 14 && values[3] === 13;
            if (isRoyal) return { name: 'Royal Flush', rank: 9, highCard, hasAceKing }; if (isFlush && isStraight) return { name: 'Straight Flush', rank: 8, highCard, hasAceKing };
            if (counts[0] === 4) return { name: 'Four of a Kind', rank: 7, highCard, hasAceKing }; if (counts[0] === 3 && counts[1] === 2) return { name: 'Full House', rank: 6, highCard, hasAceKing };
            if (isFlush) return { name: 'Flush', rank: 5, highCard, hasAceKing }; if (isStraight) return { name: 'Straight', rank: 4, highCard, hasAceKing };
            if (counts[0] === 3) return { name: 'Three of a Kind', rank: 3, highCard, hasAceKing }; if (counts[0] === 2 && counts[1] === 2) return { name: 'Two Pair', rank: 2, highCard, hasAceKing };
            if (counts[0] === 2) return { name: 'Pair', rank: 1, highCard, hasAceKing }; return { name: `${sorted[4].value} High`, rank: 0, highCard, hasAceKing };
        }
        function resetGame() {
            gameInProgress = false;
            setTimeout(() => {
                playerHand = []; dealerHand = []; document.getElementById('dealer-hand').innerHTML = ''; document.getElementById('player-hand').innerHTML = '';
                document.getElementById('dealer-hand-name').textContent = ''; document.getElementById('player-hand-name').textContent = '';
                document.getElementById('decrease-bet').disabled = false; document.getElementById('increase-bet').disabled = false;
                document.getElementById('deal-btn').disabled = false; document.getElementById('raise-btn').disabled = true; document.getElementById('fold-btn').disabled = true;
            }, 3000);
        }
        function showMessage(text, type) { const messageEl = document.getElementById('message'); messageEl.textContent = text; messageEl.className = `message ${type}`; }
        window.onload = init;
    </script>
</body>
</html>
